# C·∫£i ti·∫øn Logic Nghi·ªáp v·ª• TDMU Dispatch

## üìã **T·ªïng quan**

T√†i li·ªáu n√†y m√¥ t·∫£ c√°c c·∫£i ti·∫øn logic nghi·ªáp v·ª• cho h·ªá th·ªëng TDMU Dispatch, bao g·ªìm:

1. **Logic t·∫°o workflow th√¥ng minh**
2. **Ph√¢n lo·∫°i vƒÉn b·∫£n theo tr·∫°ng th√°i x·ª≠ l√Ω**
3. **ƒê·ªìng b·ªô tr·∫°ng th√°i Document v√† Workflow**
4. **Log x·ª≠ l√Ω vƒÉn b·∫£n chi ti·∫øt**
5. **Qu·∫£n l√Ω quy·ªÅn theo vai tr√≤**

## üîÑ **1. Logic T·∫°o Workflow Th√¥ng Minh**

### **Nguy√™n t·∫Øc t·∫°o workflow:**

```typescript
private shouldCreateWorkflow(document: Document, workflowTemplateId?: number): boolean {
  // 1. User ch·ªâ ƒë·ªãnh template c·ª• th·ªÉ
  if (workflowTemplateId) {
    return true;
  }
  
  // 2. VƒÉn b·∫£n ƒëi (OUTGOING) - lu√¥n c·∫ßn workflow ph√™ duy·ªát
  if (document.documentType === DocumentTypeEnum.OUTGOING) {
    return true;
  }
  
  // 3. VƒÉn b·∫£n ƒë·∫øn (INCOMING) - c·∫ßn workflow x·ª≠ l√Ω
  if (document.documentType === DocumentTypeEnum.INCOMING) {
    return true;
  }
  
  // 4. VƒÉn b·∫£n n·ªôi b·ªô (INTERNAL) - ch·ªâ c·∫ßn workflow n·∫øu c√≥ y√™u c·∫ßu ƒë·∫∑c bi·ªát
  if (document.documentType === DocumentTypeEnum.INTERNAL && document.priority === DocumentPriority.HIGH) {
    return true;
  }
  
  return false;
}
```

### **Template mapping theo lo·∫°i vƒÉn b·∫£n v√† ƒë·ªô ∆∞u ti√™n:**

| Lo·∫°i VƒÉn b·∫£n | ƒê·ªô ∆∞u ti√™n | Template ID | M√¥ t·∫£ |
|--------------|------------|-------------|-------|
| OUTGOING | LOW/MEDIUM | 1 | Quy tr√¨nh ph√™ duy·ªát vƒÉn b·∫£n th√¥ng th∆∞·ªùng |
| OUTGOING | HIGH/URGENT | 2 | Quy tr√¨nh ph√™ duy·ªát vƒÉn b·∫£n t√†i ch√≠nh (nhanh h∆°n) |
| INCOMING | LOW/MEDIUM | 3 | Quy tr√¨nh x·ª≠ l√Ω vƒÉn b·∫£n ƒë·∫øn |
| INCOMING | HIGH/URGENT | 4 | Quy tr√¨nh x·ª≠ l√Ω vƒÉn b·∫£n ƒë·∫øn kh·∫©n c·∫•p |
| INTERNAL | LOW/MEDIUM | 5 | Quy tr√¨nh n·ªôi b·ªô ƒë∆°n gi·∫£n |
| INTERNAL | HIGH/URGENT | 6 | Quy tr√¨nh n·ªôi b·ªô ph·ª©c t·∫°p |

## üìä **2. Ph√¢n lo·∫°i VƒÉn b·∫£n Theo Tr·∫°ng th√°i X·ª≠ l√Ω**

### **C√°c tr·∫°ng th√°i vƒÉn b·∫£n:**

```typescript
export enum DocumentStatus {
  DRAFT = 'DRAFT',           // B·∫£n nh√°p
  PENDING = 'PENDING',       // Ch·ªù x·ª≠ l√Ω
  PROCESSING = 'PROCESSING', // ƒêang x·ª≠ l√Ω
  APPROVED = 'APPROVED',     // ƒê√£ ph√™ duy·ªát
  REJECTED = 'REJECTED',     // ƒê√£ t·ª´ ch·ªëi
  COMPLETED = 'COMPLETED',   // ƒê√£ ho√†n th√†nh
  CANCELLED = 'CANCELLED',   // ƒê√£ h·ªßy
}
```

### **Ph√¢n lo·∫°i theo nghi·ªáp v·ª•:**

| Nh√≥m | Tr·∫°ng th√°i | M√¥ t·∫£ |
|------|------------|-------|
| **Ch·ªù x·ª≠ l√Ω** | DRAFT, PENDING | VƒÉn b·∫£n ch∆∞a ƒë∆∞·ª£c x·ª≠ l√Ω |
| **ƒêang x·ª≠ l√Ω** | PROCESSING | VƒÉn b·∫£n ƒëang trong quy tr√¨nh workflow |
| **Ho√†n th√†nh** | APPROVED, COMPLETED | VƒÉn b·∫£n ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω xong |
| **T·ª´ ch·ªëi** | REJECTED, CANCELLED | VƒÉn b·∫£n b·ªã t·ª´ ch·ªëi ho·∫∑c h·ªßy |

## üîó **3. ƒê·ªìng b·ªô Tr·∫°ng th√°i Document v√† Workflow**

### **Mapping tr·∫°ng th√°i:**

```typescript
async updateDocumentStatusFromWorkflow(documentId: number, workflowStatus: string): Promise<void> {
  let newStatus: DocumentStatus;
  
  switch (workflowStatus) {
    case 'IN_PROGRESS':
      newStatus = DocumentStatus.PROCESSING;
      break;
    case 'COMPLETED':
      newStatus = DocumentStatus.APPROVED;
      break;
    case 'REJECTED':
      newStatus = DocumentStatus.REJECTED;
      break;
    case 'CANCELLED':
      newStatus = DocumentStatus.CANCELLED;
      break;
    default:
      newStatus = DocumentStatus.PROCESSING;
  }
  
  // C·∫≠p nh·∫≠t tr·∫°ng th√°i vƒÉn b·∫£n
  document.status = newStatus;
  await this.documentRepository.save(document);
}
```

### **T·ª± ƒë·ªông c·∫≠p nh·∫≠t khi workflow thay ƒë·ªïi:**

- **Workflow IN_PROGRESS** ‚Üí Document PROCESSING
- **Workflow COMPLETED** ‚Üí Document APPROVED  
- **Workflow REJECTED** ‚Üí Document REJECTED
- **Workflow CANCELLED** ‚Üí Document CANCELLED

## üìù **4. Log X·ª≠ l√Ω VƒÉn b·∫£n Chi ti·∫øt**

### **C√°c lo·∫°i log:**

```typescript
export enum ActionType {
  APPROVE = 'APPROVE',     // Ph√™ duy·ªát
  REJECT = 'REJECT',       // T·ª´ ch·ªëi
  TRANSFER = 'TRANSFER',   // Chuy·ªÉn ti·∫øp
  CANCEL = 'CANCEL',       // H·ªßy b·ªè
  START = 'START',         // B·∫Øt ƒë·∫ßu
  COMPLETE = 'COMPLETE',   // Ho√†n th√†nh
  ASSIGN = 'ASSIGN',       // G√°n vƒÉn b·∫£n
}
```

### **Th√¥ng tin log:**

```typescript
interface WorkflowActionLog {
  id: number;
  instanceId: number;        // ID workflow instance
  stepId: number;           // ID b∆∞·ªõc hi·ªán t·∫°i
  actionType: ActionType;   // Lo·∫°i h√†nh ƒë·ªông
  actionByUserId: number;   // ID ng∆∞·ªùi th·ª±c hi·ªán
  actionByUser: User;       // Th√¥ng tin ng∆∞·ªùi th·ª±c hi·ªán
  actionAt: Date;           // Th·ªùi gian th·ª±c hi·ªán
  note: string;             // Ghi ch√∫
  metadata: string;         // D·ªØ li·ªáu b·ªï sung (JSON)
}
```

### **API l·∫•y l·ªãch s·ª≠ x·ª≠ l√Ω:**

```graphql
query documentProcessingHistory($documentId: Int!) {
  documentProcessingHistory(documentId: $documentId) {
    metadata {
      statusCode
      message
    }
    data {
      history {
        id
        actionType
        actionByUser {
          id
          fullName
          email
        }
        actionAt
        note
        stepName
        stepType
      }
    }
  }
}
```

## üë• **5. Qu·∫£n l√Ω Quy·ªÅn Theo Vai tr√≤**

### **Ph√¢n quy·ªÅn theo vai tr√≤:**

| Vai tr√≤ | Quy·ªÅn xem vƒÉn b·∫£n | Quy·ªÅn t·∫°o | Quy·ªÅn g√°n | Quy·ªÅn x·ª≠ l√Ω |
|---------|-------------------|-----------|-----------|-------------|
| **SYSTEM_ADMIN** | T·∫•t c·∫£ | ‚úÖ | ‚úÖ | ‚úÖ |
| **UNIVERSITY_LEADER** | OUTGOING, INTERNAL | ‚úÖ | ‚úÖ | ‚úÖ |
| **DEPARTMENT_STAFF** | C·ªßa m√¨nh + ƒë∆∞·ª£c giao | ‚úÖ | ‚úÖ | ‚úÖ |
| **CLERK** | C·ªßa m√¨nh + ƒë∆∞·ª£c giao | ‚úÖ | ‚ùå | ‚úÖ |
| **BASIC_USER** | Ch·ªâ c·ªßa m√¨nh | ‚ùå | ‚ùå | ‚ùå |

### **Logic ph√¢n quy·ªÅn:**

```typescript
// L·ªçc theo quy·ªÅn c·ªßa user
if (user.roles.includes('SYSTEM_ADMIN')) {
  // Admin c√≥ th·ªÉ xem t·∫•t c·∫£
} else if (user.roles.includes('UNIVERSITY_LEADER')) {
  // L√£nh ƒë·∫°o c√≥ th·ªÉ xem vƒÉn b·∫£n c·∫•p tr∆∞·ªùng
  query.andWhere('document.documentType IN (:...types)', { 
    types: [DocumentTypeEnum.OUTGOING, DocumentTypeEnum.INTERNAL] 
  });
} else if (user.roles.includes('DEPARTMENT_STAFF')) {
  // Nh√¢n vi√™n ph√≤ng ban ch·ªâ xem vƒÉn b·∫£n c·ªßa m√¨nh ho·∫∑c ƒë∆∞·ª£c giao
  query.andWhere('(document.createdByUserId = :userId OR document.assignedToUserId = :userId)', { 
    userId: user.id 
  });
} else {
  // BASIC_USER ch·ªâ xem vƒÉn b·∫£n c·ªßa m√¨nh
  query.andWhere('document.createdByUserId = :userId', { userId: user.id });
}
```

## üöÄ **6. API M·ªõi**

### **Queries m·ªõi:**

```graphql
# L·∫•y vƒÉn b·∫£n c·∫ßn x·ª≠ l√Ω c·ªßa user
query myDocumentsForProcessing {
  myDocumentsForProcessing {
    metadata { statusCode, message }
    data { documents { id, title, status, priority } }
  }
}

# L·∫•y vƒÉn b·∫£n theo tr·∫°ng th√°i
query myDocumentsByStatus($status: String!) {
  myDocumentsByStatus(status: $status) {
    metadata { statusCode, message }
    data { documents { id, title, status, priority } }
  }
}

# Th·ªëng k√™ vƒÉn b·∫£n
query myDocumentStatistics {
  myDocumentStatistics {
    metadata { statusCode, message }
    data { 
      statistics { 
        pending, processing, completed, rejected, total 
      } 
    }
  }
}

# L·ªãch s·ª≠ x·ª≠ l√Ω vƒÉn b·∫£n
query documentProcessingHistory($documentId: Int!) {
  documentProcessingHistory(documentId: $documentId) {
    metadata { statusCode, message }
    data { history { actionType, actionByUser, actionAt, note } }
  }
}

# T√¨m ki·∫øm vƒÉn b·∫£n
query searchDocuments($searchTerm: String, $status: DocumentStatus, $documentType: DocumentTypeEnum, $priority: DocumentPriority) {
  searchDocuments(searchTerm: $searchTerm, status: $status, documentType: $documentType, priority: $priority) {
    metadata { statusCode, message }
    data { documents { id, title, status, priority, documentType } }
  }
}
```

### **Mutations m·ªõi:**

```graphql
# G√°n vƒÉn b·∫£n cho user kh√°c
mutation assignDocumentToUser($documentId: Int!, $assignedToUserId: Int!) {
  assignDocumentToUser(documentId: $documentId, assignedToUserId: $assignedToUserId) {
    metadata { statusCode, message }
    data { document { id, title, assignedToUser { id, fullName } } }
  }
}

# C·∫≠p nh·∫≠t tr·∫°ng th√°i vƒÉn b·∫£n t·ª´ workflow (Admin only)
mutation updateDocumentStatusFromWorkflow($documentId: Int!, $workflowStatus: String!) {
  updateDocumentStatusFromWorkflow(documentId: $documentId, workflowStatus: $workflowStatus) {
    metadata { statusCode, message }
    data { success }
  }
}
```

## üìà **7. Lu·ªìng X·ª≠ l√Ω VƒÉn b·∫£n**

### **Lu·ªìng c∆° b·∫£n:**

1. **T·∫°o vƒÉn b·∫£n** ‚Üí Status: DRAFT
2. **T·ª± ƒë·ªông t·∫°o workflow** ‚Üí Status: PENDING
3. **User x·ª≠ l√Ω** ‚Üí Status: PROCESSING
4. **Ho√†n th√†nh workflow** ‚Üí Status: APPROVED/REJECTED

### **Lu·ªìng chi ti·∫øt:**

```
T·∫°o vƒÉn b·∫£n (DRAFT)
    ‚Üì
Ki·ªÉm tra c·∫ßn workflow?
    ‚Üì
T·∫°o workflow instance (PENDING)
    ‚Üì
User c√≥ quy·ªÅn x·ª≠ l√Ω?
    ‚Üì
Th·ª±c hi·ªán action (PROCESSING)
    ‚Üì
C√≤n b∆∞·ªõc ti·∫øp theo?
    ‚Üì
Ho√†n th√†nh workflow (APPROVED/REJECTED)
    ‚Üì
C·∫≠p nh·∫≠t document status
```

## üîß **8. C·∫•u h√¨nh v√† T√πy ch·ªânh**

### **C·∫•u h√¨nh template mapping:**

```typescript
// C√≥ th·ªÉ t√πy ch·ªânh trong config
const templateMapping = {
  [DocumentTypeEnum.OUTGOING]: {
    [DocumentPriority.LOW]: 1,
    [DocumentPriority.MEDIUM]: 1,
    [DocumentPriority.HIGH]: 2,
    [DocumentPriority.URGENT]: 2,
  },
  // ... c√°c lo·∫°i kh√°c
};
```

### **C·∫•u h√¨nh deadline:**

```typescript
// Deadline m·∫∑c ƒë·ªãnh theo ƒë·ªô ∆∞u ti√™n
const deadlineMapping = {
  [DocumentPriority.LOW]: 14,      // 14 ng√†y
  [DocumentPriority.MEDIUM]: 7,    // 7 ng√†y
  [DocumentPriority.HIGH]: 3,      // 3 ng√†y
  [DocumentPriority.URGENT]: 1,    // 1 ng√†y
};
```

## ‚úÖ **9. L·ª£i √≠ch c·ªßa C·∫£i ti·∫øn**

### **Cho ng∆∞·ªùi d√πng:**
- ‚úÖ Hi·ªÉn th·ªã vƒÉn b·∫£n theo ƒë√∫ng vai tr√≤
- ‚úÖ Ph√¢n lo·∫°i r√µ r√†ng theo tr·∫°ng th√°i
- ‚úÖ L·ªãch s·ª≠ x·ª≠ l√Ω chi ti·∫øt
- ‚úÖ T√¨m ki·∫øm v√† l·ªçc n√¢ng cao

### **Cho qu·∫£n tr·ªã:**
- ‚úÖ Logic nghi·ªáp v·ª• r√µ r√†ng
- ‚úÖ T·ª± ƒë·ªông h√≥a quy tr√¨nh
- ‚úÖ Ki·ªÉm so√°t quy·ªÅn ch·∫∑t ch·∫Ω
- ‚úÖ B√°o c√°o v√† th·ªëng k√™

### **Cho h·ªá th·ªëng:**
- ‚úÖ Hi·ªáu su·∫•t cao
- ‚úÖ D·ªÖ b·∫£o tr√¨ v√† m·ªü r·ªông
- ‚úÖ ƒê·ªìng b·ªô d·ªØ li·ªáu ch√≠nh x√°c
- ‚úÖ Log ƒë·∫ßy ƒë·ªß ƒë·ªÉ audit

## üéØ **10. K·∫øt lu·∫≠n**

C√°c c·∫£i ti·∫øn logic nghi·ªáp v·ª• ƒë√£ t·∫°o ra m·ªôt h·ªá th·ªëng:

1. **Th√¥ng minh h∆°n** - T·ª± ƒë·ªông t·∫°o workflow ph√π h·ª£p
2. **R√µ r√†ng h∆°n** - Ph√¢n lo·∫°i tr·∫°ng th√°i logic
3. **An to√†n h∆°n** - Qu·∫£n l√Ω quy·ªÅn ch·∫∑t ch·∫Ω
4. **Chi ti·∫øt h∆°n** - Log ƒë·∫ßy ƒë·ªß m·ªçi h√†nh ƒë·ªông
5. **Linh ho·∫°t h∆°n** - D·ªÖ t√πy ch·ªânh v√† m·ªü r·ªông

H·ªá th·ªëng gi·ªù ƒë√¢y ƒë√°p ·ª©ng ƒë·∫ßy ƒë·ªß y√™u c·∫ßu nghi·ªáp v·ª• c·ªßa TDMU v√† c√≥ th·ªÉ ph√°t tri·ªÉn th√™m trong t∆∞∆°ng lai.
