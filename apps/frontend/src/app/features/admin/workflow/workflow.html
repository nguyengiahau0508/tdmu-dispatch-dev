<div class="workflow">
  <div class="workflow__header">
    <div class="header__group">
      <div class="header__search">
        <input type="text" placeholder="Tìm quy trình..." />
      </div>
      <div class="header__add">
        <button (click)="toggleWorkflowTemplateCreate()">
          <img src="/icons/add.svg" alt="Thêm" />
          Thêm quy trình
        </button>
      </div>
    </div>
    <div class="header__group header__group--block">
      <app-pagination [totalCount]="totalCount || 0" [pageOptions]="pageOptions" (pageChange)="onPageChange($event)"
        (pageSizeChange)="onPageSizeChange($event)" (orderChange)="onOrderChange($event)"></app-pagination>
    </div>
  </div>
  
  <div class="workflow__main">
    @if (workflowTemplates.length > 0) {
    <table class="workflow__table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tên quy trình</th>
          <th>Mô tả</th>
          <th>Trạng thái</th>
          <th>Số bước</th>
          <th>Người tạo</th>
          <th>Ngày tạo</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        @for (workflowTemplate of workflowTemplates; track workflowTemplate.id) {
        <tr class="workflow-row">
          <td>{{ workflowTemplate.id }}</td>
          <td>
            <div class="workflow-name">
              <span class="name">{{ workflowTemplate.name }}</span>
            </div>
          </td>
          <td>
            <span class="description">{{ workflowTemplate.description || 'Không có mô tả' }}</span>
          </td>
          <td>
            <span class="status-badge" [class]="getStatusClass(workflowTemplate.isActive)">
              {{ getStatusLabel(workflowTemplate.isActive) }}
            </span>
          </td>
          <td>
            <span class="steps-count">{{ workflowTemplate.steps.length || 0 }} bước</span>
          </td>
          <td>
            <span class="creator">{{ workflowTemplate.createdByUser.fullName || 'N/A' }}</span>
          </td>
          <td>{{ workflowTemplate.createdAt | date:'dd/MM/yyyy' }}</td>
          <td class="row-actions">
            <div class="actions-menu">
              <button class="menu-button" (click)="toggleMenu(workflowTemplate.id)">⋮</button>

              @if (selectedMenuId === workflowTemplate.id) {
              <div class="dropdown-menu" (mouseleave)="toggleMenu(workflowTemplate.id)">
                <button class="menu-item" (click)="viewWorkflowTemplateDetail(workflowTemplate)">
                  <img src="/icons/eye.svg" alt="Xem" />
                  Xem chi tiết
                </button>
                <button class="menu-item" (click)="editWorkflowTemplate(workflowTemplate)">
                  <img src="/icons/edit.svg" alt="Sửa" />
                  Chỉnh sửa
                </button>
                <button class="menu-item menu-item--danger" (click)="deleteWorkflowTemplate(workflowTemplate)">
                  <img src="/icons/delete.svg" alt="Xóa" />
                  Xóa
                </button>
              </div>
              }
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>
    } @else {
    <div class="empty-state">
      <img src="/icons/empty.svg" alt="Không có dữ liệu" />
      <p>Chưa có quy trình nào được tạo.</p>
      <button class="btn btn-primary" (click)="toggleWorkflowTemplateCreate()">
        Tạo quy trình đầu tiên
      </button>
    </div>
    }
  </div>
</div>

<!-- Workflow Template Create Modal -->
@if (isWorkflowTemplateCreateOpen) {
<app-workflow-template-create 
  [isOpen]="isWorkflowTemplateCreateOpen" 
  (closeModal)="toggleWorkflowTemplateCreate()"
  (createdSuccessfully)="onWorkflowTemplateCreated()" />
}

<!-- Workflow Template Update Modal -->
@if (isWorkflowTemplateUpdateOpen && selectedWorkflowTemplate) {
<app-workflow-template-update 
  [isOpen]="isWorkflowTemplateUpdateOpen" 
  [workflowTemplate]="selectedWorkflowTemplate"
  (closeModal)="toggleWorkflowTemplateUpdate()"
  (updatedSuccessfully)="onWorkflowTemplateUpdated()" />
}

<!-- Workflow Template Detail Modal -->
@if (isWorkflowTemplateDetailOpen && selectedWorkflowTemplate) {
<app-workflow-template-detail 
  [isOpen]="isWorkflowTemplateDetailOpen" 
  [workflowTemplateId]="selectedWorkflowTemplate.id"
  (closeModal)="toggleWorkflowTemplateDetail()" />
}
