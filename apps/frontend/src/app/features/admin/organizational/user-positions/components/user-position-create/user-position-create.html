@if (isOpen) {
  <div class="user-position-create__backdrop" (click)="onClose()">
    <div class="user-position-create" (click)="$event.stopPropagation()">
      <div class="user-position-create__header">
        <div class="header__content">
          <h2 class="header__title">Thêm chức vụ cho người dùng</h2>
          <p class="header__subtitle">Gán chức vụ và phòng ban mới cho người dùng</p>
        </div>
        <button class="header__close-btn" (click)="onClose()" title="Đóng">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <form class="user-position-create__form" [formGroup]="userPositionCreateForm" (ngSubmit)="onSubmit()">
        <div class="form-section">
          <h4 class="form-section__title">Thông tin chức vụ</h4>
          
          <!-- Department Selection -->
          <div class="form-group">
            <label for="departmentId" class="form-group__label">
              Phòng ban <span class="required">*</span>
            </label>
            <div class="form-group__select-wrapper">
              <select 
                id="departmentId" 
                class="form-group__select" 
                formControlName="departmentId"
                (change)="onDepartmentChange($event)"
              >
                <option value="">Chọn phòng ban</option>
                @for(department of departments; track department.id) {
                  <option [value]="department.id">{{ department.name }}</option>
                }
              </select>
              <svg class="form-group__select-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"></polyline>
              </svg>
            </div>
            <div class="form-group__help">Chọn phòng ban mà người dùng sẽ làm việc</div>
          </div>

          <!-- Position Selection -->
          <div class="form-group">
            <label for="positionId" class="form-group__label">
              Chức vụ <span class="required">*</span>
            </label>
            <div class="form-group__select-wrapper">
              <select 
                id="positionId" 
                class="form-group__select" 
                formControlName="positionId"
                [disabled]="!userPositionCreateForm.get('departmentId')?.value"
              >
                <option value="">Chọn chức vụ</option>
                @for(position of positionsOfDepartment; track position.id) {
                  <option [value]="position.id">
                    {{ position.positionName }} 
                    ({{ position.currentSlotCount }}/{{ position.maxSlots }})
                  </option>
                }
              </select>
              <svg class="form-group__select-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"></polyline>
              </svg>
            </div>
            <div class="form-group__help">
              @if(userPositionCreateForm.get('departmentId')?.value) {
                Chọn chức vụ trong phòng ban đã chọn
              } @else {
                Vui lòng chọn phòng ban trước
              }
            </div>
          </div>

          <!-- Start Date -->
          <div class="form-group">
            <label for="startDate" class="form-group__label">
              Ngày bắt đầu <span class="required">*</span>
            </label>
            <input 
              type="date" 
              id="startDate" 
              class="form-group__input" 
              formControlName="startDate"
              [max]="today"
            />
            <div class="form-group__help">Ngày người dùng bắt đầu chức vụ mới</div>
          </div>
        </div>

        <!-- Summary Section -->
        <div class="form-section">
          <h4 class="form-section__title">Tóm tắt</h4>
          <div class="summary-info">
            <div class="summary-item">
              <span class="summary-item__label">Phòng ban:</span>
              <span class="summary-item__value">
                @if(userPositionCreateForm.get('departmentId')?.value) {
                  {{ getDepartmentName(userPositionCreateForm.get('departmentId')?.value) }}
                } @else {
                  <span class="summary-item__value--empty">Chưa chọn</span>
                }
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-item__label">Chức vụ:</span>
              <span class="summary-item__value">
                @if(userPositionCreateForm.get('positionId')?.value) {
                  {{ getPositionName(userPositionCreateForm.get('positionId')?.value) }}
                } @else {
                  <span class="summary-item__value--empty">Chưa chọn</span>
                }
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-item__label">Ngày bắt đầu:</span>
              <span class="summary-item__value">
                @if(userPositionCreateForm.get('startDate')?.value) {
                  {{ userPositionCreateForm.get('startDate')?.value | date:'dd/MM/yyyy' }}
                } @else {
                  <span class="summary-item__value--empty">Chưa chọn</span>
                }
              </span>
            </div>
          </div>
        </div>
      </form>

      <!-- Actions -->
      <div class="user-position-create__actions">
        <button type="button" class="btn btn-secondary" (click)="onClose()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Hủy
        </button>
        <button type="submit" class="btn btn-primary" (click)="onSubmit()" [disabled]="userPositionCreateForm.invalid">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
          </svg>
          Thêm chức vụ
        </button>
      </div>
    </div>
  </div>
}